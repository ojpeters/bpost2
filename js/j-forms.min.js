var pictureSource;   // picture source
var destinationType; // sets the format of returned value
var imagedata="";
var email=comment=username=thesignature=rfq=contractorname=hours=beatno=streetno=streetaddress="";
 
document.addEventListener("deviceready", onDeviceReady, false);
 
function onDeviceReady() {
    pictureSource = navigator.camera.PictureSourceType;
    destinationType = navigator.camera.DestinationType;
	$.mobile.initializePage();
}




// A button will call this function
//
function capturePhoto() {
    sessionStorage.removeItem('imagepath');
	//$('#takePicBtn').on('click',function (e){
		// e.preventDefault();
		// Take picture using device camera and retrieve image as base64-encoded string
		navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50, encodingType : Camera.EncodingType.JPEG,
		targetWidth: 150,
		targetHeight: 150,
		destinationType: Camera.DestinationType.FILE_URI });
	//});
	showAlert("started");
}

function onPhotoDataSuccess(imageURI) { 
        // Uncomment to view the base64 encoded image data,      		 
		  // var imgProfile = document.getElementById('imgProfile');
        // Show the captured photo
        // The inline CSS rules are used to resize the image
        showAlert("Picture captured,Image url:"+imageURI);
        //imgProfile.src = imageURI;
		$('#mimage').append("<img src="+imageURI+" />");
		sessionStorage.setItem('imagepath', imageURI);//store value in session 
		
}
// Called if something bad happens.
// 
function onFail(message) {
    showAlert('Failed because: ' + message);
}

function movePic(file){ 
    window.resolveLocalFileSystemURI(file, resolveOnSuccess, resOnError); 
} 

//Callback function when the file system uri has been resolved
function resolveOnSuccess(entry){ 
    var d = new Date();
    var n = d.getTime();
    //new file name
    var newFileName = n + ".jpg";
    var myFolderApp = "appfiles";

    window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, function(fileSys) {      
    //The folder is created if doesn't exist
    fileSys.root.getDirectory( myFolderApp,
                    {create:true, exclusive: false},
                    function(directory) {
                        entry.moveTo(directory, newFileName,  successMove, resOnError);
                    },
                    resOnError);
                    },
    resOnError);
}

//Callback function when the file has been moved successfully - inserting the complete path
function successMove(entry) {
    //Store imagepath in session for future use
    // like to store it in database
    sessionStorage.setItem('imagepath', entry.fullPath);
	//showAlert("starting upload to ofullpath"+entry.fullPath);	 
	uploadPhoto(entry.fullPath);
}

function resOnError(error) {
    showAlert(error.code);
}
function showAlert(message) {
	navigator.notification.alert(
		message,  // message
		alertDismissed,         // callback
		'Notice:',            // title
		'OK'                  // buttonName
	);
}
function postData() {
	
	var target="http://www.ojpeters.com/app/dopost.php";	
	//addTolocalDB();		
		var formData = $("#j-forms").serialize();	

				$.ajax({
					type: "POST",
					url: target,
					cache: false,
					data: formData,
					dataType: 'text',
					beforeSend: function() {
						$('#j-forms button[type="submit"]').attr("disabled",!0).addClass("processing")	
					},
					complete: function() {

					},
					success: function (result) {
						 $('#j-forms #response').html("response:"+result);	
						 								
								$('#j-forms button[type="submit"]').attr("disabled",!1).removeClass("processing"),
								$("#j-forms .success-message").length&&($("#j-forms .input").removeClass("success-view error-view"),
								$("#j-forms .check").removeClass("success-view error-view"),
								$("#j-forms").resetForm(),
								$('#j-forms button[type="submit"]').attr("disabled",!0), 
								$("#j-forms .multi-prev-btn").attr("disabled",!0),
								setTimeout(function(){
									$("#j-forms #response").removeClass("success-message").html(""),
									$('#j-forms button[type="submit"]').attr("disabled",!1),
									$("#j-forms .multi-prev-btn").attr("disabled",!1),
									$("#j-forms .multi-prev-btn").css("display","none"),
									$("#j-forms .multi-submit-btn").css("display","none"),
									$("#j-forms fieldset").removeClass("active-fieldset"),
									$("#j-forms fieldset").eq(0).addClass("active-fieldset"),
									e()
								},
								5e3))
					},
					error:  function(err) {
					
						$('#response').html("ErrorText: "+ err);
							
					}        

			});
	

} 


$(document).ready(function(){
	//posting
	

	function e(){
		$("#j-forms .logic-block-checkbox").change(function(){
		$("#next-step-checkbox").is(":checked")?($(".multi-next-btn").css("display","block"),
		
		$("#takePicBtn").css("display","none"),
		$(".multi-submit-btn").css("display","none")):(
		$(".multi-next-btn").css("display","none"),
		//$("#bt2").css("display","none"),
		//$("#bt2").css("display","block"))
		$("#takePicBtn").css("display","block"),
		$(".multi-submit-btn").css("display","block"))
		}).change()
		}
		$("#phone").mask("(999) 999-9999",
		{placeholder:"x"}),
		$("#pickup_date").datetimepicker({
			dateFormat:"mm/dd/yy",
		timeFormat:"hh:mm",
		prevText:'<i class="fa fa-caret-left"></i>',
		nextText:'<i class="fa fa-caret-right"></i>'
		}),
		$("#return_date").datetimepicker({
			dateFormat:"mm/dd/yy",timeFormat:"hh:mm",
		prevText:'<i class="fa fa-caret-left"></i>',nextText:'<i class="fa fa-caret-right"></i>'}),
		$("#j-forms").validate({
			errorClass:"error-view",validClass:"success-view",
			errorElement:"span",onkeyup:!1,onclick:!1,
			rules:{name:{required:!0},
					pickup_date:{required:!0},
					return_date:{required:!0},
					title:{required:!0},
					airline_flight_number:{required:!0},
					pickup_address:{required:!0}
				},
				messages:{
						name:{required:"Please enter your name"},
						pickup_date:{required:"Please enter pickup date"},return_date:{required:"Please enter return date"},
						title:{required:"Please enter an title name"},
						airline_flight_number:{required:"Please enter a flight number"},
						pickup_address:{required:"Please enter pickup address"}
						},
				highlight:function(e,s,t){
						$(e).closest(".input").removeClass(t).addClass(s),
						($(e).is(":checkbox")||$(e).is(":radio"))&&$(e).closest(".check").removeClass(t).addClass(s)
						},
				unhighlight:function(e,s,t){
						$(e).closest(".input").removeClass(s).addClass(t),
						($(e).is(":checkbox")||$(e).is(":radio"))&&$(e).closest(".check").removeClass(s).addClass(t)
						},
				errorPlacement:function(e,s){
						$(s).is(":checkbox")||$(s).is(":radio")?$(s).closest(".check").append(e):$(s).closest(".unit").append(e)
				},
				submitHandler:function(){
				postData();
				}
			}),
				$("form.j-multistep").length&&$("form.j-multistep").each(function(){
					var s=$(this).attr("id"),
						t=$("#"+s+" fieldset").length,
						i=$("#"+s+" .step").length,
						a=$("#"+s+" .multi-next-btn"),
						r=$("#"+s+" .multi-prev-btn"),
						l=$("#"+s+" .multi-submit-btn"),
						d=$("#"+s+" .logic-block-checkbox").closest("fieldset").index("fieldset");
						
					$("#"+s+" fieldset").eq(0).addClass("active-fieldset"),
					i&&$("#"+s+" .step").eq(0).addClass("active-step"),
					$("#"+s+" fieldset").eq(0).hasClass("active-fieldset")&&(l.css("display","none"),
					r.css("display","none"),
					e()),
					l.click(function(){
						for(var e=$("#"+s+" fieldset").length,
						t=$("#"+s).find("fieldset.active-fieldset").index("fieldset");e>t+1;
						)
						$("#"+s+" fieldset").eq(e-1).find('select, textarea, input[type="text"], input[type="email"]').val(""),
						$("#"+s+" fieldset").eq(e-1).find('input[type="radio"], input[type="checkbox"]').prop("checked",!1),
						e--
						}),
					a.on("click",function(){
							return 1!=$("#"+s).valid()?!1:($("#"+s+" fieldset.active-fieldset").removeClass("active-fieldset").next("fieldset").addClass("active-fieldset"),i&&$("#"+s+" .step.active-step").removeClass("active-step").addClass("passed-step").next(".step").addClass("active-step"),
							r.css("display","block"),
							$("#takePicBtn").css("display","block"),
							$("#"+s+" fieldset").eq(t-1).hasClass("active-fieldset")&&(l.css("display","block"),a.css("display","none")),void 0)
					}),
					r.on("click",function(){
								$("#"+s+" fieldset.active-fieldset").removeClass("active-fieldset").prev("fieldset").addClass("active-fieldset"),i&&$("#"+s+" .step.active-step").removeClass("active-step").prev(".step").removeClass("passed-step").addClass("active-step"),$("#"+s+" fieldset").eq(0).hasClass("active-fieldset")&&r.css("display","none"),$("#"+s+" fieldset").eq(d-1).hasClass("active-fieldset")&&(l.css("display","none"),a.css("display","block")),$("#"+s+" fieldset").eq(t-2).hasClass("active-fieldset")&&(l.css("display","none"),a.css("display","block"))
					})
				})
				
  });
  
  function test(){
	  var imageURI="http://www.ojpeters.com/wp-content/uploads/2016/05/posted_name4.jpg";
	  $('#mimage').append("<img src="+imageURI+" />");
	  
  }